---
layout: post
title: "linuxæŠ“åŒ…å‘½ä»¤tcpdump"
category: linux 
---


## ç®€ä»‹
ç½‘ç»œä¸–ç•Œï¼Œè®¡ç®—æœºç³»ç»Ÿè¢«åˆ†æˆä¸åŒçš„å±‚çº§ï¼Œæ¯”å¦‚ï¼šOSI æ¨¡å‹ï¼ˆ7å±‚ï¼‰ã€TCP/IP æ¨¡å‹ï¼ˆå››å±‚ï¼‰ã€äº”å±‚æ¨¡å‹ã€‚å…¶å¯¹åº”ç³»å¦‚ä¸‹å›¾ğŸ‘‡ï¼š

![Untitled.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f960f359ab9b45809a4e9d5cb8192ed4~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=608&h=295&s=149021&e=png&b=faf6f5)

å…¶ä¸­ï¼Œåœ¨æ¯ä¸€å±‚éƒ½ä¸å¯ç¼ºå°‘çš„åˆ†å‡ºäº†ä¼ è¾“å±‚å’Œç½‘ç»œå±‚ã€‚ç½‘ç»œå±‚ç”¨äºå°†æ•°æ®ä»ä¸€å°ä¸»æœºä¼ è¾“åˆ°ä½äºä¸åŒç½‘ç»œä¸­çš„å¦ä¸€å°ä¸»æœºã€‚è€Œä¼ è¾“å±‚ä¼šä»ç½‘ç»œå±‚è·å–æœåŠ¡ï¼Œå¹¶å‘åº”ç”¨å±‚æä¾›æœåŠ¡ã€‚

æˆ‘ä»¬è¦è§£è¯´çš„tcpdumpï¼ˆdump the traffic on a networkï¼‰å°±æ˜¯æŠ“å–åœ¨ç½‘ç»œå±‚å’Œä¼ è¾“å±‚æµé€šçš„æ•°æ®ã€‚tcpdumpæ˜¯ä¾èµ–äºlibpcapå‡½æ•°åº“çš„linuxå‘½ä»¤ï¼Œç”¨æ¥æŠ“å–ç½‘ç»œä¸­çš„æµé‡åŒ…ã€‚


## tcpdumpå¸¸ç”¨å‚æ•°
### åŸºç¡€ä½¿ç”¨
```sh
tcpdump -V ## ç‰ˆæœ¬å·
man tcpdump ## æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£
tcpdum -D ## æ‰“å°æ‰€æœ‰å¯ç”¨çš„ç½‘ç»œæ¥å£åˆ—è¡¨
```
### 1. tcpdumpæŠ“å–å†…å®¹ä»‹ç»
å•ç‹¬æ‰§è¡Œ`tcpdump`è·å–é»˜è®¤æŠ“åŒ…ä¿¡æ¯ï¼š
```txt
18:17:30.137623 IP x.x.x.x.ndmp > x-x-x-x.ssh: Flags [.], ack 15613, win 811, options [nop,nop,TS val 1760701871 ecr 4166071444], length 0
```
æ•°æ®åŒ…å†…å®¹æŒ‰ç…§é¡ºåºä¾æ¬¡ä¸ºï¼šæ“ä½œæ‰§è¡Œçš„æ—¶é—´ã€åè®®ç±»å‹ã€å‘é€æ–¹åœ°å€ã€æ¥æ”¶æ–¹åœ°å€ã€å‘é€å†…å®¹
### 2. æ§åˆ¶æ—¶é—´æ ¼å¼çš„æ˜¾ç¤º -t
ä¸åŒæ•°é‡çš„`t`å¯æ˜¾ç¤ºä¸åŒæ•ˆæœ
```sh
## æ—¶é—´æ˜¾ç¤ºæ ¼å¼ -t
tcpdump -c 1 -t ## è¿”å›æ•°æ®æ²¡æœ‰æ—¶é—´ 
tcpdump -c 1 -tt ## è¿”å›ç§’çº§åˆ«æ—¶é—´æˆ³ 
tcpdump -c 1 -ttt ## è¿”å›ä¸¤æ¬¡æŠ“åŒ…ä¹‹é—´çš„æ—¶é—´é—´éš” 
tcpdump -c 1 -tttt ## è¿”å›2023-11-15 18:50:37.497681æ ¼å¼æ—¶é—´
```
### 3. æŠ“å–æŒ‡å®šåè®®ç±»å‹
åœ¨tcpdumpåé¢ç›´æ¥æ¥åè®®ç±»å‹å³å¯è¿‡æ»¤
```sh
tcpdump tcp # æŠ“å–tcpåè®®æ•°æ®åŒ… 
tcpdump icmp 0.0.0.0 # è¿‡æ»¤ç½‘ç»œå±‚/ä¼ è¾“å±‚åè®®
```
psï¼šè¿™é‡Œåªèƒ½è¿‡æ»¤ä¼ è¾“å±‚ã€ç½‘ç»œå±‚åè®®ï¼Œè¿‡æ»¤å…¶ä»–å±‚åè®®æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚æ¯”å¦‚ï¼š`tcpdump http 0.0.0.0`ï¼Œå› ä¸ºhttpåè®®æ˜¯åº”ç”¨å±‚çš„ã€‚
### 4. åŸºäºæº/ç›®æ ‡åœ°å€åšè¿‡æ»¤ï¼šhostã€dstã€srcã€-Qã€--direction
```sh
## åŸºäºå‘é€/æ¥æ”¶åŒæ–¹è¿‡æ»¤ï¼šä½¿ç”¨å‚æ•°ï¼š`host`ã€`dst`ã€`src`
tcpdump host x.x.x.x ## æŠ“å–å‘é€æ–¹æˆ–æ¥æ”¶æ–¹ä¸ºä¸»æœºx.x.x.xçš„æ•°æ®
tcpdump dst x.x.x.x ## æŠ“å–æ¥æ”¶æ–¹ä¸ºä¸»æœºx.x.x.xçš„æ•°æ®
tcpdump src x.x.x.x ## æŠ“å–å‘é€æ–¹ä¸ºä¸»æœºx.x.x.xçš„æ•°æ®

## æ§åˆ¶æµé‡æ–¹å‘ -Qï¼ŒåŒ --direction
## -Q çš„optionï¼šinã€outã€allï¼›in-å¤–ç½‘å›æ¥çš„æµé‡ï¼Œout-å‡ºå»çš„æµé‡ï¼Œall-æ‰€æœ‰ï¼›
```

### 5. åŸºäºå†…å®¹åšè¿‡æ»¤
```sh
## æ§åˆ¶æŠ“å–åŒ…çš„æ¡æ•° -c
tcpdump -c 10 ## æŠ“å–10æ¡æ•°æ®åè‡ªåŠ¨åœæ­¢

## åŸºäºåŒ…å¤§å°è¿›è¡Œè¿‡æ»¤
tcpdump less 32 ## æŠ“å–åŒ…å°äº32bytesçš„åŒ…
tcpdump greater 100 ## æŠ“å–åŒ…å¤§äº100bytesçš„åŒ…

## é™åˆ¶æŠ“åŒ…çš„æ•°é‡ -Cï¼Œå’Œ-w ä¸€èµ·ä½¿ç”¨
## æŠ“åŒ…é‡æ»¡åï¼Œä¼šè‡ªåŠ¨åœæ­¢æŠ“åŒ…
tcpdump -C 1 -W 3 -w abc  ## -Cåé¢çš„1è¡¨ç¤ºæŠ“å–1MBå¤§å°çš„æ–‡ä»¶ï¼Œ-Wè¡¨ç¤ºæŠ“å–æ–‡ä»¶çš„æœ€å¤§æ•°é‡ï¼Œ-wåé¢è¡¨ç¤ºæŠ“å–æ–‡ä»¶çš„åå­—ï¼Œè¯¥å‘½ä»¤ä¼šæŠ“å–3ä¸ª1MBå¤§å°çš„æ–‡ä»¶ï¼Œæ–‡ä»¶ååˆ†åˆ«ä¸ºï¼šabc1ï¼Œabc2ï¼Œabc3
tcpdump -C 1 -w abc ## æ²¡æœ‰æŒ‡å®š-Wï¼ŒæŠ“å–çš„æ–‡ä»¶æ•°é‡ä¼šä¸€ç›´å¢åŠ 
## è®¾ç½®-Wåï¼Œæµé‡è¶…å‡ºå°±ä¼šè¦†ç›–å†™å…¥æ—§æ–‡ä»¶

## æ‰“å°ç®€æ´ä¿¡æ¯ -qï¼šè¾ƒå°‘çš„åè®®ç›¸å…³ä¿¡æ¯

## æŒ‡å®šæ¯ä¸ªåŒ…æ•è·é•¿åº¦ -s é»˜è®¤ï¼š2622144bytes
tcpdump -s 22  ## æŠ“å–22bytesçš„åŒ…æµé‡

## é€‰æ‹©ç½‘å¡ -i
## linuxç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`ifconfig`å‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿç½‘å¡ï¼Œé€šè¿‡`-i`å‚æ•°é€‰æ‹©æŒ‡å®šç½‘å¡çš„æ•°æ®ã€‚
tcpdump -i eth0 ## æŠ“å–ä»eth0ç½‘å¡è¿›å…¥çš„æ•°æ®

## æ‰“å°æ•°æ®é“¾è·¯å±‚çš„å¤´éƒ¨ä¿¡æ¯ -e
## æ˜¾ç¤ºæº&ç›®çš„çš„MACåœ°å€ã€VLAN tagä¿¡æ¯
```

#### 6. è¿‡æ»¤ä¿¡æ¯ä¿å­˜
```sh
## ä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ -w
tcpdump -w xxx.pcap

## -l åœ¨éœ€è¦åŒæ—¶è§‚å¯ŸæŠ“åŒ…æ‰“å°ä»¥åŠä¿å­˜æŠ“åŒ…æ—¶ä½¿ç”¨
tcpdump -l | tee dat ## æŠ“å–æ•°æ®åŒ…å†…å®¹å®æ—¶æ‰“å°å¹¶ä¿å­˜åˆ°datæ–‡ä»¶ä¸­
tcpdump -l > dat | & tail -f dat ## æ•ˆæœåŒä¸Š
```

#### 7. è¯»å–æ–‡ä»¶
```sh
tcpdump -r xx.cap ## æ˜¾ç¤ºxx.cap æ–‡ä»¶å†…å®¹
tcpdump -A -r xx.cap ## ä»¥ASCIIæ ¼å¼æ‰“å°å‡ºæ‰€æœ‰çš„åˆ†ç»„å¹¶è¯»å–æ­¤æ–‡ä»¶
tcpdump -x -r xx.cap ## ä»¥åå…­è¿›åˆ¶å’ŒASCIIæ ¼å¼åŒæ—¶æ‰“å°å‡ºæ­¤æ–‡ä»¶
## -A å’Œ -x ä¸å¯åŒæ—¶ä½¿ç”¨
```
#### 8. é€»è¾‘è¿ç®—
é€»è¾‘è¿ç®—ç¬¦å·æœ‰ï¼š&&ã€||ã€| ,ä¹Ÿå¯ä»¥ç›´æ¥ç”¨è‹±æ–‡å­—æ¯ï¼šandã€orã€not
```sh
tcpdump src xxxx and port 80 ## è·å–æºåœ°å€ä¸ºxxxxï¼Œä¸”ç«¯å£å·ä¸º80çš„æµé‡åŒ…
tcpdump tcp port 53 or udp port 53
tcpdump not tcp port 22
```
åœ¨é€»è¾‘è¿ç®—ä¸­ï¼Œ`and`çš„ä¼˜å…ˆçº§å¤§äº`or`ï¼Œå¦‚æœéœ€è¦å…ˆæ‰§è¡Œ`or`å†æ‰§è¡Œ`and`ï¼Œéœ€è¦ç”¨`æ‹¬å·`
```sh
tcpdump "src xx and (dst port 3389 or 22)"
```

## é€šè¿‡WiresharkæŸ¥çœ‹tcpdumpå†…å®¹
åœ¨æŠ“å–ç½‘ç»œæ•°æ®åï¼Œé€šè¿‡`-w`å‘½ä»¤å°†æ•°æ®å†™å…¥`xx.pcap`æ–‡ä»¶ä¸­ã€‚
### Wiresharkæ‰“å¼€pcapæ–‡ä»¶
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b643b544499248119b0cb685bbfeff52~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2274&h=1652&s=1729255&e=png&b=f1f1f1)
æ‰“å¼€ç•Œé¢å¦‚ä¸‹ï¼š
![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/db58f38bf5da4a2ea77fb7a8261c801d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2164&h=1592&s=614344&e=png&b=eeeeee)
### Wiresharkè¿‡æ»¤pcapæ–‡ä»¶
![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d8869c6b225497494a3d202c4b3ec2e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2112&h=306&s=139169&e=png&b=dddddd)
##### å¸¸ç”¨è¿‡æ»¤æ¡ä»¶
```sh
## è¿‡æ»¤å•ä¸ªipåœ°å€
ip.src == 12.3.1.1  ## è¿‡æ»¤æºipä¸º12.3.1.1çš„æ•°æ®
ip.dst == 12.3.1.1  ## è¿‡æ»¤ç›®çš„ipä¸º12.3.1.1çš„æ•°æ®
ip.addr == 12.3.1.1 ## è¿‡æ»¤æºipæˆ–è€…ç›®çš„ipä¸º12.3.1.1çš„æ•°æ®
ip.addr != 12.3.1.1 ## è¿‡æ»¤æºipå’Œç›®çš„ipéƒ½ä¸æ˜¯12.3.1.1çš„æ•°æ®
!(ip.addr == 12.3.1.1) ## è·å– æºipæˆ–è€…ç›®çš„ipä¸º12.3.1.1 ä¹‹å¤–çš„æ•°æ®

## é’ˆå¯¹åè®®åŒºåˆ†
tcp ## è¿‡æ»¤å‡ºtcpåè®®çš„æ•°æ®åŒ…
!tcp ## è¿‡æ»¤étcpåè®®çš„æ•°æ®åŒ…
tcp or udp ## è¿‡æ»¤å‡ºtcpå’Œudpä¸¤ç§åè®®çš„æ•°æ®åŒ…
## å¦‚æœ.pcapæ–‡ä»¶ä¸­æœ‰åè®®ç±»å‹ä¸ºSSHã€Kafkaçš„æ•°æ®åŒ…ï¼Œåœ¨tcpå‘½ä»¤è¿‡æ»¤æ—¶ï¼Œè¿™äº›æ•°æ®ä¹Ÿä¼šå±•ç¤ºå‡ºæ¥ã€‚å› ä¸ºSSHå’ŒKafkaåè®®å±äºåº”ç”¨å±‚åè®®ï¼Œå…¶ä¼ è¾“å±‚çš„åè®®ä¾ç„¶æ˜¯tcpåè®®ã€‚

## ç«¯å£è¿‡æ»¤ï¼šç«¯å£è¿‡æ»¤æ˜¯ä¾é™„äºåè®®çš„ï¼Œ
tcp.port == 22  ## è¿‡æ»¤tcpåè®®ä¸­ç«¯å£å·ä¸º22çš„æ•°æ®åŒ…
tcp.port == 22 || udp.port == 80 ## è¿‡æ»¤tcpåè®®ç«¯å£å·ä¸º22ä»¥åŠudpåè®®ä¸­ç«¯å£å·ä¸º80çš„æ•°æ®åŒ…

```
ä¸Šé¢åªæ˜¯åˆ—ä¸¾äº†ä¸€äº›å¸¸ç”¨çš„è¿‡æ»¤å‘½ä»¤ï¼Œè¿™é‡Œ[æ¨èè¿æ¥](https://www.cnblogs.com/willingtolove/p/12519490.html#%E6%98%BE%E7%A4%BA%E8%BF%87%E6%BB%A4%E5%99%A8%E5%86%99%E6%B3%95)å¯ä»¥æŸ¥çœ‹æ›´è¯¦ç»†çš„å†™æ³•ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å‘½ä»¤è¡Œè¾“å…¥çš„æ—¶å€™é€šè¿‡å›è½¦æ¥æŸ¥çœ‹wiresharkæ”¯æŒçš„è¿‡æ»¤å‘½ä»¤ã€‚
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60f53ee37a254316a5bea65cd43e10bd~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1980&h=884&s=1218607&e=png&b=e4e3fa)

### è§£æTCPæ•°æ®åŒ…
ä¸‹å›¾ä¸ºtcpæ•°æ®åŒ…å†…å®¹è¯¦è§£
![ä¼ä¸šå¾®ä¿¡æˆªå›¾_cb022331-ed99-4adc-b07d-5fa84ef4a2ad.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d79faa40e03d45318ae8e1bdfecc1237~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1930&h=738&s=844638&e=png&b=f9f0ea)
æ•°æ®åŒ…å†…å®¹åœ¨wiresharkè§£æç»“æœæ˜¾ç¤ºå¦‚ä¸‹ï¼š
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b9d28bdf440d427e83e37a2668d6a52f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2228&h=1418&s=779895&e=png&b=fcfcfc)
